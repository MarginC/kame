			CHANGELOG for KAME kit

$KAME: CHANGELOG,v 1.1608 2001/03/18 19:23:13 fujisawa Exp $

<200103>
2001-03-19  Shin'ichi Fujisawa  <shin@dianthus.kame.net>
	* Add initial version of NAT-PT plan.

2001-03-18  Shin'ichi Fujisawa  <fujisawa@kame.net>
	* freebsd4/sys/netinet/ip_input.c 
	  - Move NATPT hook to just before check to see if the packet is
	    for us.  Because NATPT need one more extra IPv4 address to
	    translate IPv6 to IPv4 when this NATPT hook was put after this
	    inspection.
	  - Change indent to an 8 character tab.
	* kame/sys/netinet6/natpt_dispatch.c 
	  - Add IPv6 outbound packet counter.
	  - Fix bug of comparison that size of packet exceeds mtu.
	* kame/sys/netinet6/natpt_trans.c 
	  - Fix a bug to clear UDP header when calculate UDP checksum.
	* kame/sys/netinet6/natpt_{defs.h,dispatch.c,tslot.c}
	  - Remove code evading a bug of SuMiRe NAT.
	    SuMiRe NAT is obsolete.

Thu Mar 15 20:39:03 JST 2001 sakane@ydc.co.jp
	* racoon:
	- fixed a phase 2 handler deletion.  racoon will delete a phase2
	  handler immediately when hard lifetime expires.
	- check a unit of the timer in the configuration file.

Thu Mar 15 17:48:54 JST 2001  itojun@iijlab.net
	* sys/netinet/ip_mroute.c: use sys/netinet/ip_encap.c framework
	  for inbound packet dispatch.

2001-03-15  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/sys/netinet6/in6.c (in6_ifinit): always set nd6_rtrequest
	to ifa_rtrequest.
	* kame/sys/netinet6/nd6_rtr.c (nd6_prefix_onlink): because of the
	above change, the function does not set the ifa_rtrequest
	function.
	* kame/sys/netinet6/in6.c (in6_ifloop_request): set the address
	itself as gateway, and set the RTF_LLINFO flag to the
	corresponding host route, so that the route would have the flag,
	and thus applications (e.g. routing daemons) that assume
	traditional kernel behavior would be happy.  Older versions made
	the route to the node's own address like this:
	2001:200::3ca2:ffef:eff5:f9fd ::1  UH lo0
	However, since some routing daemons try to install kernel internal
	routes that do not have the RTF_LLINFO flag, this kind of entry
	could cause unintentional host routes propagated.  The new kernel,
	instead, installs
	2001:200::c049:d099:ab4b:b637 0:a0:12:34:ab:cd UHL lo0
	just like far older versions of the kernel (except for the
	existance of the cloned bit), which installed the host route as a
	cloned route from the corresponding interface direct route.

2001-03-13  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* freebsd2/ports/wu-ftpd: upgraded to wu-ftpd 2.6.1.  Since there
	are security holes in older versions, upgrade is recommended.

Mon Mar 12 20:17:43 JST 2001  itojun@iijlab.net
	* sys/crypto/sha2/sha2.c: hmac-sha2-{256,384,512} support.  attaches
	  96 bits of crypto checksum (not sure if this is right - there's no
	  draft on this).
	  TODO: interop tests

2001-03-11  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/sys/netinet6/ip6_output.c (ip6_output): added a couple of
	missing splx() for OpenBSD IPsec.

2001-03-08  Atsushi Onoe <onoe@sm.sony.co.jp>
	* kame/route6d.c: correct deleting host route, based on
	report from enami@sm.sony.co.jp.

2001-03-06  Jason R. Thorpe  <thorpej@zembu.com>

	* kame/racoon/schedule.c: Implement sched_scrub_param(),
	which kills all scheduler work queue entries which a
	specified parameter.
	* kame/racoon/handler.c: Use sched_scrub_param() to make
	sure no references to a handler exist when it is freed.

2001-03-06  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/sys/netinet6/nd6_rtr.c (nd6_prefix_onlink): set RTF_GATEWAY
	to an interface direct route when nd6_need_cache() is false, in
	order to prevent nd6_rtrequest() from setting RTF_LLINFO (which
	annoys the ndp(8) command).
	This change is based on a report from nobumichi ozoe
	<nobumichi_ozoe@ydc.co.jp>.

Tue Mar  6 09:22:56 JST 2001  itojun@iijlab.net
	* sys/netinet6/raw_ip6.c: permit IPV6_CHECKSUM socket option for
	  the following cases only (previously it was allowed for any AF_INET6
	  socket): raw ip6 socket, and protocol != IPPROTO_ICMPV6.
	  RFC2292 section 3.1.  commented by yoshfuji.

2001-03-05  Jason R. Thorpe  <thorpej@zembu.com>

	* kame/racoon/gssapi.c: Use GSS_C_MECH_CODE when reporting
	GSSAPI errors.

2001-03-05  Jason R. Thorpe  <thorpej@zembu.com>

	* kame/racoon/handler.c: Implement deleteallph2(), which
	deletes all Phase 2 handlers for a given src/dst/proto.
	* kame/racoon/isakmp_inf.c: When processing INITIAL-CONTACT,
	try to use the SADB_DELETE `delete all' extension and
	deleteallph2() before doing it The Hard Way.  For both The
	Easy Way and The Hard Way, make sure we only delete SAD entries
	for SATYPEs that we manage.
	* kame/racoon/pfkey.c: Use a table of SATYPEs that we manage,
	and use that table to initialize our PF_KEY state.

2001-03-05  Jason R. Thorpe  <thorpej@zembu.com>

	* kame/libipsec/pfkey.c: Add pfkey_send_delete_all(), which
	sends an SADB_DELETE with satype/mode/src/dst.

Mon Mar  5 JST 2001  itojun@iijlab.net
	* sys/netinet6/raw_ip6.c: avoid 1-byte mbuf buffer overrun, and/or
	  unaligned memory access, in rip6_output().  commented by yoshfuji.
	  it will be tickled only if a evil/buggy root process runs.

2001-03-04  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/sys/netinet6/nd6.c (nd6_free): moved a line calling
	pfxlist_onlink_check() before the default router selection part,
	based on a request from Mattias Pettersson
	<mattias.pettersson@verkstad.net>.

2001-03-03  Shin'ichi Fujisawa  <fujisawa@kame.net>
	* kame/pma/*: removed.
	  This function is obsolete.

2001-03-03  Shin'ichi Fujisawa  <fujisawa@kame.net>
	* sys/netinet6/natpt_usrreq.c (natpt_uattach) call natpt_attach if
	  privileged process.
	* sys/netinet6/natpt_rule.c (natpt_in4_len2mask): convert host
	  byte order of calculated mask.
	* sys/conf/options (freebsd4): add NATPT_NAT
	* kame/natptconfig/show.c: Fix struct nlist symbol name.  Change
	  string compare method, check string length in the first place.

	  TODO: It is not so good to read '/dev/kmem', I need to think about
	  another method to read these variables from kernel.

2001-03-02  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/sys/netinet6/nd6_rtr.c (prelist_update): clarified the
	update routine for an existing prefix.  It now tries to update
	some parameters even if the L bit is zero.  This would be
	necessary for the case where a router first advertises the prefix
	without the L bit being set, and next the same prefix with the bit
	being set.

Fri Mar  2 20:05:23 2001  SUMIKAWA Munechika  <sumikawa@ebina.hitachi.co.jp>
	* netbsd/usr.bin/tftp/main.c: port checking fix.
	  from h-yamamo@db3.so-net.ne.jp.

Fri Mar  2 16:11:17 JST 2001  itojun@iijlab.net
	* sys/crypto/{twofish,rijndael}: change key initialization API to
	  pass binary keys instead of hexadecimal string keys.

Fri Mar  2 01:48:24 JST 2001  itojun@iijlab.net
	* sys/netinet/ip_input.c (all *bsd): drop packets from outside
	  if these contain 127/8 in ip_src or ip_dst.

Thu Mar  1 20:01:14 JST 2001	suz@sdl.hitachi.co.jp
	* bsdi3/sys/netinet/raw_ip.c
	fixed a bug that bsdi3 KAME with IPsec crashes when it receives 	
	an ICMP packet

Thu Mar  1 18:28:48 JST 2001  itojun@iijlab.net
	* sys/netinet/ip_input.c, sys/netinet6/ip6_input.c (except openbsd):
	  enforce inbound policy match on all final protocol headers.
	  previously, inbound policy is enforced only for udp/tcp/icmp.
	  basically the fix is for transport mode case.
	  XXX ipsec policy engine still needs a great amount of updates.
	* freebsd4/sys/netinet/in_proto.c: add ipcomp input support.

<200102>
Wed Feb 28 23:26:26 JST 2001  itojun@iijlab.net
	* sys/netinet6/esp_output.c: support random length padding in ESP,
	  to avoid traffic analysis on short packets.  by setting
	  net.inet.ipsec.esp_randpad (or net.inet6.ipsec6.esp_randpad) to
	  positive value N, you can ask the kernel to randomly pad packets
	  shorter than N bytes, to random length smaller than or equal to N.
	  note that N does not include ESP authentication data length.
	  also note that the random padding is not included in TCP segment
	  size computation.

	  recommeded value for N is like 128, or 256 (if you use a too big
	  number as N, you may experience inefficiency due to fragmented
	  packets).

Mon Feb 26 22:53:02 2001  SUMIKAWA Munechika  <sumikawa@ebina.hitachi.co.jp>
	* sys/netinet6/nd6.c : do not overwrite llcache if static ndp is
	  set

Mon Feb 26 18:21:08 JST 2001  itojun@iijlab.net
	* sys/netinet6/ip6_{in,out}put.c: support 2553bis-03 IPV6_V6ONLY
	  socket option (not finished yet).
	  (1) supply net.inet6.ip6.v6only on all platforms.  it shows the
	  kernel default behavior for IPV6_V6ONLY socket option.  mutable
	  on netbsd/freebsd3/freebsd4, immutable on other platforms.
	  (2) support IPV6_V6ONLY on all platforms.  on netbsd/freebsd3/
	  freebsd4, the socket option is mutable and has per-socket state.
	  on other platforms, we can only read it (you can set it if the
	  value is same as the default - non-changeable - behavior).

	  TODO: synchronize AF_INET6 socket behavior with 2553bis-03, from
	  IPV6_V6ONLY POV (at least netbsd does not meet 2553bis-03, as the
	  socket option controls inbound only, should control both inbound
	  and outbound).  *bsd have their own preference on kernel default
	  behavior due to security risks, so will change that.

	  NOTE: netbsd IPV6_BINDV6ONLY is now obsoleted.  old binaries should
	  just work (IPV6_V6ONLY uses same socket option # as IPV6_BINDV6ONLY).
	  NOTE: freebsd net.inet6.ip6.mapped_addr is obsoleted.

Mon Feb 26 15:36:51 JST 2001  itojun@iijlab.net
	* sys/netinet*/raw*.c: validate inbound IPsec policy on raw socket
	  processing.  from: kalyan@juniper.net

2001-02-25  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/sys/netinet6/nd6.c (nd6_need_cache): separated from
	nd6_output() to decide whether to make a neighbor cache entry for
	the link of a given interface.  This function is (currently)
	called from nd6_output() and nd6_prefix_onlink(), and make the
	decision policy consistent.
	Based on the current policy, we do not make a neighbor cache for a
	loopback link, in response to a comment from Miyata-san@YDC.

Thu Feb 22 10:08:27 JST 2001 sakane@ydc.co.jp
	* racoon:
	fixed to check the outbound policy when the responder received the
	1st packet in phase 2.  the tunnel mode and the transport specified
	the pair of IP addresses of the end of the SA had failed.

Thu Feb 22 01:59:01 JST 2001  itojun@iijlab.net
	* sys/netinet6/{dest6,nd6}.c: make variable length header parsing
	  pickier (= safer).
	* sys/netinet6/frag6.c: fix behavior on memory shortage/too many
	  reass queues.
	* openbsd/include/netdb.h: change ai_addrlen from int to socklen_t,
	  to conform to 2553bis-03.

Wed Feb 21 14:25:55 JST 2001 sakane@ydc.co.jp
	* racoon:
	changed the proposal order of the protocol in the phase 2.
	If we want to make a packet "IP2 AH ESP IP1 ULP", the SPD in KAME
	expresses AH transport + ESP tunnel.  racoon sent the proposal
	contained such the order.  But lots of implementation interprets
	AH tunnel + ESP tunnel in this case.  racoon changes the order,
	and usually uses this format.  If the option, 'complex_bundle'
	is enable, racoon uses old format.

Wed Feb 21 13:04:17 JST 2001  itojun@iijlab.net
	* openbsd/usr.sbin/pim6{sd,dd}: compile these on openbsd.
	  not really tested.

Wed Feb 21 13:00:00 JST 2001  itojun@iijlab.net
	* sys/netinet6/ah_{core,output}.c: one more correction to IPv4 option
	  chasing in AH processing.

Mon Feb 19 20:51:41 JST 2001  itojun@iijlab.net
	* sys/netinet6/ipsec.c (netbsd only): correct severe memory leak
	  in ipsec operation.  the bug was introduced on 2/14/2001.

Mon Feb 19 15:03:24 JST 2001  itojun@iijlab.net
	* sys/netinet6/ah_{core,output}.c: correct IPv4 option chasing in
	  AH processing.  the change is important if you use IPsec.

Mon Feb 19 11:49:29 JST 2001  itojun@iijlab.net
	* netbsd/usr.sbin/pppd: sync with 1.5 tree.

2001-02-19  Shin'ichi Fujisawa  <fujisawa@kame.net>
	* freebsd4/sys/netinet/ip_input.c: Add a NATPT hook into ip_input().
	* freebsd4/sys/netinet/ip_proto.c: Add a NATPT entry into struct
	  ipprotosw inetsw[].
	* sys/netinet6/ip6_input.c: include "opt_natpt.h" when FreeBSD
	  version is more than 3.

	  Sorry, there is a problem a little, and NATPT does not work yet.

2001-02-16  Jason R. Thorpe  <thorpej@zembu.com>
	* sys/netkey/key.c: When processing an SADB_DELETE message,
	  allow SADB_EXT_SA to be blank.  In this case, we delete
	  all non-LARVAL SAs that match the src/dst/protocol.  This
	  is particularly useful in IKE INITIAL-CONTACT processing.
	  Idea from Bill Sommerfeld <sommerfeld@east.sun.com>, who
	  implemented it in post-Solaris8.
	* kame/setkey/parse.y, kame/setkey/token.l,
	  kame/setkey/setkey.8: Add a "deleteall" command that takes
	  a src/dst/protocol.

Sat Feb 17 01:51:43 JST 2001  itojun@iijlab.net
	* sys/netinet6/nd6.c: recover backward binary compatibility for
	  SIOCGIFINFO_IN6.
	* openbsd/sys/netinet/udp_usrreq.c: remove IPv6 cases from udp_output()
	  to simplify it and make it easier to audit it (sync with openbsd-
	  current).

Wed Feb 14 17:37:34 JST 2001  itojun@iijlab.net
	* sys/kern/uipc_mbuf2.c: make sure to return non-shared mbuf on
	  calls to m_pulldown().

Wed Feb 14 16:27:49 JST 2001  itojun@iijlab.net
	* sys/netinet6/ip6_input.c: merge mbuf data into single mbuf, if
	  mbuf chain is passed to ip6_input.  it makes IPv6 packet processed
	  okay when L2 code passes non-continuous mbuf data (like L2 bridge
	  code).  affects freebsd[234] and bsdi[34] only.

Tue Feb 13 18:42:17 2001  SUMIKAWA Munechika  <sumikawa@ebina.hitachi.co.jp>
	* freebsd4/sys/{if_sppp.h,if_spppsubr.c}: supported PPPv6 for
	  kernel level PPP.

2001-02-11  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/sys/netinet6/in6.c (in6if_do_dad): was added to centralize
	the decision of whether DAD should be performed on a particular
	interface.  This function is currently called from
	in6_update_ifa() and in6_ifattach_linklocal().

2001-02-09  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/sys/netinet6/in6_ifattach.c (in6_ifattach): skipped
	assignment of link-local addresses when interfaces become up,
	if ip6_auto_linklocal is 0 (its default is 1).  By setting 0 to
	this variable and manually configuring link-local addresses, you
	can use well-known interface identifiers for servers/router/etc.
	This variable can be configured via sysctl
	net.inet6.ip6.auto_linklocal or by the IP6_AUTO_LINKLOCAL kernel
	compilation option.  If you configure the variable via sysctl, you
	should be sure that all interfaces are NOT up.
	Note that the variable effects all interfaces.  When you set 0 to
	the variable, you should configure link-local addresses for all
	interfaces that you might want to use.
	
Fri Feb  9 00:51:01 JST 2001  itojun@iijlab.net
	* sys/netinet6/in6.h: correct SA6_ARE_ADDR_EQUAL definition.
	  kernel responds to ping6 -w again.

Fri Feb  9 00:18:46 JST 2001  itojun@iijlab.net
	* sys/netinet6/icmp6.c: negative {mtudisc,redirect}_{hi,lo}wat
	  value will turn off the checks.  See changelog on 2000/12/09.

2001-02-08  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/sys/netinet6/nd6.c (nd6_free): returned the pointer to the
	next entry of the freed one.  Since pfxlist_onlink_check() called
	from this function could change the link structure, the caller
	would need the "real" successor of the list to avoid to refer to
	invalid memory.  This fix actually fixed a problem that the kernel
	hunged in some (rare) cases.

Wed Feb  7 21:35:26 JST 2001  itojun@iijlab.net
	* sys/kern/uipc_socket.c (netbsd/openbsd/freebsd4/bsdi4):
	  return ECONNABORTED, if the socket (tcp connection for example)
	  is disconnected by RST right before accept(2).  fixes PR 10698/12027.
	  checked with SUSv2, XNET 5.2, and Stevens (unix network programming
	  vol 1 2nd ed) section 5.11.
	  bsdi3/freebsd[23] needs some other fix here, so they are left behind.

	  NOTE: unix domain socket behavior needs checking.

2001-02-07  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* bsdi4/usr.sbin/netstat/route.c (p_sockaddr): removed special
	cases of ::/plen (plen > 0).  I believe it is better than the
	original behavior, which printed those routes "v6-in-v4 default".

Wed Feb  7 16:19:19 JST 2001  itojun@iiljab.net
	* sys/netinet6/raw_ip6.c (netbsd/openbsd): validate/notify path MTU
	  discovery correctly for raw ip6 sockets.
	  note: since ping6 does not use connect(2) for the socket for
	  outgoing traffic, ping6 will have issues with route pointer kept
	  in in6pcb - need to restart ping6 to reflect new pmtu.

Wed Feb  7 01:08:46 JST 2001  itojun@iijlab.net
	* netbsd/sys/net/route.c: ignore redirect attempt, if we are to
	  create/update routing entry with the same value in rt_key and
	  rt_gateway.  response to NetBSD PR 4827.  experimental.

2001-02-06  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/sys/netinet6/nd6.c (nd6_p2p_rtrequest): removed.  It was
	introduced long long ago, and is not necessary any more,
	especially after the recent clarification on the address/prefix
	management.

Tue Feb  6 13:08:24 JST 2001 itojun@iijlab.net
	* sys/netinet6/nd6*.c: minimize number of log() or printf() on inbound
	  packet processing path, to avoid /var from get filled up with with
	  bogus packet storms.
	* sys/netinet6/icmp6.c: supply new sysctl net.inet6.icmp6.nd6_debug,
	  to turn on/off error/warning messages on inbonud ND/ICMPv6 packets.
	  disabled by default, can be enabled by default if you have
	  "options ND6_DEBUG".
	* sys/netinet6: OLD_LOOPBACK_IF is no longer supported (see changelog
	  on 2000/7/30).

2001-02-06  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/sys/netinet6/in6.c (in6_update_ifa): always set the
	destination address when specified regardless of the type of the
	interface.  This would solve a problem that bsdi3 could not add a
	route that has ::1 as the gateway (bsdi3 specific, maybe).
	This fix was in response to a report from Tomomi Suzuki
	<stomomi@ebina.hitachi.co.jp>.

Tue Feb  6 10:49:36 JST 2001  itojun@iijlab.net
	* sys/netinet6/ip6_output.c: correct m->m_pkthdr.rcvif setting for
	  own linklocal address cases.  broken around Feb 2.

2001-02-05  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* *BSD/sbin/ifconfig/ifconfig.c: marked "temporary" for temporary
	IPv6 addresses (see the next log).

2001-02-05  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/sys/netinet6/: implemented RFC 3014 Privacy Extensions for
	Stateless Address Autoconfiguration.  You can enable this by
	# sysctl -w net.inet6.ip6.use_tempaddr=1
	before accepting an RA.  Once enabled, the kernel will configure
	temporary addresses as well as public autoconfigured ones, as
	described in the RFC.  Also, the kernel will prefer temporary
	addresses to public autoconfigured ones as the source address for
	a new communication.  For more details about the selection
	algorithm, see 1.6 of the KAME IMPLEMENTATION file.

2001-02-04  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/sys/netinet6 (bunch of files): completely revisited address
	and prefix manipulation:
	- centralize addition or removal of addresses to make code
	  maintainance easier.
	- separate address manipulation and prefix manipulation, including
	  + completely separate address lifetimes and prefix lifetimes.
	  + separate on-link determination from address autoconfiguration.
	  + separate route for a node's own address (to a loopback
	    interface) from an interface's direct route.
	  + separate the notion of detached addresses and the notion of
	    detached prefixes.  The latter can now be designated by the
	    "D" bit of the output from "ndp -p".
	- more conformance to RFC 2462 address autoconfiguration.
	- clarify a notion of autoconfigured addresses.

	Note: the change is so drastic, so you will probably have to clean
	all your source tree up, and then rebuild the entire kernel and
	applications.

2001-02-04  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/sys/netinet6/in6.h (IFA6_IS_{DEPRECATED, INVALID}): added
	to hide implementation of address lifetimes.  As a middle term
	solution, we should clarify the relationship among ia6t_xxx
	members and the IN6_IFF_DEPRECATED flag.  When you add code about
	address lifetimes, do not assume its implementation, and stick to
	use these macros.

2001-02-04  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/kame/rtadvd/rtadvd.c (main): the -R (router renumbering)
	option is currently ignored (with a warning message).  We will
	re-enable the option after clarifying the address/prefix
	manipulation in the kernel, and implementing missing stuff within
	rtadvd (hopefully soon).

2001-02-04  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/kame/prefix/prefix.sh (prefix): added as a tiny replacement
	of original prefix(8), based on recent clarification on the kernel
	prefix/address manipulation engine.  "Tiny" means that it does NOT
	provide complete backward compatibility with the original one.  It
	can just do simple set/delete operations using ifconfig(8) as a
	backend.  Thus, users are rather recommended not to use the prefix
	command, but should use ifconfig (8) explicitly.

Sun Feb  4 11:21:15 JST 2001  itojun@iijlab.net
	* freebsd*: do not remove prefix list on net.inet6.ip6.forwarding
	  change from 0 to 1.  the behavior is confusing, and not friendly
	  with recent changes to on-link determination logic.

2001-02-01  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/kame/rtadvd/config.c (getconfig):
	* kame/kame/rtadvd/advcap.c (agetnum):
	use a long long integer to parse numeric values to unitentional
	overflow for 32 bits integers.  With this change, you can specify
	very large value (i.e. values larger than 0x80000000) for valid
	and preferred lifetimes.
	XXX: we assume the type "long long" is more than 32 bits in length.

2001-02-01  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* {bsdi[34],freebsd4,netbsd,openbsd}/sbin/ifconfig/ifconfig.c:
	added a new modifier "autoconf" for IPv6 addresses.
	For example, when you configure an IPv6 address like this
	# ifconfig ne0 inet6 3ffe:ffff::1 prefixlen 64 autoconf
	and a router advertises RA with the prefix information for
	3ffe:ffff::, then the lifetimes of the address will be adjusted
	according to the RA.

<200101>
Wed Jan 31 17:43:23 JST 2001 sakane@ydc.cojp
	* racoon:
	If the file for saving SA information is specified in the
	configuration file, racoon will save a SA information to the file
	when negotiation will succeed.  If you launch racoon with tye -B
	option and if the file is specified, she will install SAs into the
	kernel during intialization.  racoon cleans the file when she
	shutdowns normally.  The function is useful when an abnormal
	system shutdown happened, because SAs will remain at the peer.  In
	this case, you can use the -B option then SAs will revive.

	XXX racoon simply adds SAs to the end of the file specified.

Tue Jan 30 05:03:01 JST 2001  itojun@iijlab.net
	* route6d: corrected RTA_NETMASK handling (do not look at sa_family).
	  bug report from IIJ SEIL team.

Mon Jan 29 JST 2001  itojun@iijlab.net
	* {freebsd*,openbsd}/ports/bind: disable it for security issues.
	  these were based on 8.1.2...
	* freebsd4/include/netdb.h: do not pollute namespace by inclusion of
	  sys/types.h.  declare _BSD_SOCKLEN_T_ in machine/ansi.h, avoid
	  duplicated declarations.
	  based on SUSv2, netdb.h should not pull in sys/types.h.
	  if your code become not compilable due to the change, it is because
	  of bug (or SUSv2 non-conformance) in your code.
	  (you can't assume that netdb.h would pull in sys/types.h)

Mon Jan 29 00:24:00 JST 2001  itojun@iijlab.net
	* sys/netinet/icmp6.h: synchronize some of declarations, like RA packet
	  header structure and value #defines with 2292bis-02.

Sun Jan 28 JST 2001  itojun@iijlab.net
	* netbsd: synchronize with netbsd-current change to cloning routes.
	  (1) cloning routes will be marked with RTF_CLONED.  (2) RTF_CLONED
	  routes go away when RTF_CLONING routes go away (= ARP cache goes away
	  when interface address goes away)  (3) permit overwrite of RTF_CLONED 
	  by static route settings.

2001-01-27  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/kame/libinet6/getaddrinfo.c: obsoleted EAI_ADDRFAMILY and
	EAI_NODATA according to the rfc2553bis-02 draft.
	* {bsdi3, freebsd4, netbsd, openbsd}/include/netdb.h:
	* bsdi4/contrib/bind/src/include/netdb.h:
	removed the definition of the obsoleted error types.  In order to
	minimize the possibility of binary compatibily breakage, we did
	not reorder the error number sequence.

Fri Jan 26 00:12:48 JST 2001  itojun@iijlab.net
	* bsdi3: support ART routing table lookup algorithm.
	* bsdi4: support ART routing table lookup algorithm.  inet6 only
	  due to the use of custom host lookup logic in inet.

Thu Jan 25 12:26:32 JST 2001 sakane@ydc.co.jp
	* racoon:
	Fixed to handle variable-length DH shared secret correctly.
	from <yamaya@inf.furukawa.co.jp>

Wed Jan 24 10:31:29 JST 2001  itojun@iijlab.net
	* sys/netinet6/ip6_fw.[ch]: pull security patch (fixes "established"
	  tcp filter) from FreeBSD-SA-01:08.ipfw.
	  NOTE: IPv4 ip_fw.[ch] on freebsd[234] are NOT patched (yet).

Wed Jan 24 09:32:16 JST 2001  itojun@iijlab.net
	* sys/net/radix_art.[ch]: ART routing table lookup algorithm.
	  (memory eater, but should be faster).  currently netbsd/openbsd only.

Wed Jan 24 02:46:42 JST 2001  itojun@iijlab.net
	* netbsd: make MIP6 kernel compile again.

2001-01-23  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/kame/rtadvd/config.c (getconfig): made sure to zero-clear
	manually configured prefix information structures.  Without this,
	rtadvd would not work when you configure advertised prefixes
	manually.  Please be sure to update.  This bug seemed to be
	introduced on around 2000-11-11.

Tue Jan 23 22:14:08 JST 2001  itojun@iijlab.net
	* freebsd4: share sys/netinet6/ipsec.h.  sys/netinet6/ipsec6.h is gone.
	  NOTE: "make TARGET=freebsd4 clean" is necessary on upgrade.

2001-01-23  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/sys/netinet6/in6.c (in6_update_ifa, in6_ifscrub):
	considered cases where multiple addresses with a same single
	prefix are assigned on multiple interfaces.  For example, you can
	configure
	# ifconfig ne0 3ffe:ffff::1111 alias
	# ifconfig ne1 3ffe:ffff::aaaa alias
	then both two addresses can be assigned on ne0 and ne1, resp., and
	the corresponding interface route 3ffe:ffff::/64 goes to the
	interface ne0 (i.e. 1st cofirgured one wins).  If you then delete
	the address on ne0, the interface route switches the associated
	interface to ne1.
	(we do not recommend users such a configuration, though).

Tue Jan 23 18:09:08 JST 2001  itojun@iijlab.net
	* sys/netinet6/ip6_input.c: declare ip6aux structure, which is used
	  to pass around information about the packet, across header processing
	  routines.  we plan to put header chain parsing history into here.
	* sys/netinet6/dest6.c: support home agent destination option.
	  it is made mandatory by mobile-ip6 spec.
	  XXX may have broke ericsson mobile-ip6

2001-01-23  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/sys/net/if_gif.c (gif_ioctl): set IFF_RUNNING upon sucess
	of the SIOCSIFPHYADDR ioctl (and its variations).  This is
	necessary to perform DAD on a gif interface.

2001-01-23  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/sys/netinet6/in6.c (in6_ifinit): clarified on installation
	of interface direct routes;
	- made an interface route only when
	  + prefixlen is smaller than 128, or
	  + the destination address is specified.
	- set the cloning bit of an interface route only when the prefix
	  length is smaller than 128.  And, in this case, the bit is
	  always set regardless of the interface type.  In particular, an
	  interface route with the cloning bit would be configured on a
	  p2p interface.
	This mean you can now invoke the following command:

	# ifconfig gif0 inet6 3ffe:ffff::1

	Note that there is no destination address specified, and the
	prefix length is implicitly set 64.  Also note that the
	corresponding interface route of the address would have the
	cloning bit, and neighbor caches would be created when you try to
	communicate with a destination that matches the prefix
	3ffe:ffff::/64.
	
	In summary, by the two consecutive changes, the only possible
	commands you can type are:
	# ifconfig gif0 inet6 IPv6address prefixlen plen
	(where IPv6address is an IPv6 address, plen < 128) and
	# ifconfig gif0 inet6 IPv6address IPv6dstaddress prefixlen 128	
	(where IPv6address and IPv6dstaddress are IPv6 addresses)

2001-01-23  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/sys/netinet6/in6.c (in6_update_ifa): made the argument
	validation stricter; if a destination address is specified for the
	SIOCAIFADDR_IN6 ioctl, its prefix MUST be 128. As an effect, the
	kernel now refuses the following command:
	# ifconfig gif0 inet6 3ffe:ffff::1 3ffe:ffff::2 alias
	(note that the default prefix length is 64).
	You should explicitly specify 128 as the prefix length:
	# ifconfig gif0 inet6 3ffe:ffff::1 3ffe:ffff::2 prefixlen 128 alias

	You may think this is too restrictive, but I believe it's better
	than before. We've seen many users confused about configration of
	p2p interfaces.

Tue Jan 23 13:51:34 JST 2001  itojun@iijlab.net
	* sys/netinet6/ipsec.c: record IPsec decapsulation history information,
	  so that we can use it for validating inbound packets at L4.
	* netbsd: run ipfilter only for wire format packets, not the IPsec-
	  decapsulated ones.
	  
Tue Jan 23 03:44:03 JST 2001  itojun@iijlab.net
	* netbsd/openbsd: make sure do not return garbage, when accept(2) is
	  called after socket is disconnected (like RST right after TCP
	  establishment).

Mon Jan 22 JST 2001  itojun@iijlab.net
	* route6d: advertise aggregated route, only to interfaces specified
	  after -A option.  found by IIJ IPv6 router torture testers.

2001-01-21  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/sys/netinet6/nd6_rtr.c (in6_{ifadd, ifdel}): ifa_refcnt
	clarifications:
	- do not IFAREF in in6_ifadd() (except on nbsd)
	- do not duplicate IFAFREE in in6_ifdel() (except on nbsd)
	without these changes, a manually configured ifaddr would be freed
	two times when its lifetime expired. Although such a situation
	would be rare, all *BSD (except NetBSD)	users (who use versions
	after Jan 2, 2001) are recommended to apply this fix.

Sun Jan 21 JST 2001  itojun@iijlab.net
	* libinet6/getaddrinfo.c: disallow invalid scope identifier
	  (like fe80::1%junk).  it was broken around Jan 5 2001.

2001-01-21  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* bsdi4/sbin/ifconfig/ifconfig.c (main): set IPv6 address
	lifetimes correctly (i.e. set infinite). Without this, ifconfig
	would not be able to assign IPv6 addresses.

Sun Jan 21 00:26:47 PST 2001  itojun@iijlab.net
	* sys/netinet6/ip6_input.c: do not accept packet to link-local address
	  on loopback interface, if the destination address is not assigned
	  to the node itself.  fixes KAME PR 250.

Sun Jan 21 01:37:23 2001  SUMIKAWA Munechika  <sumikawa@ebina.hitachi.co.jp>
	* sys/netinet6/{nd6.c,nd6_nbr.c,nd6.h}: implement garbage
	  collection for a stale NDP entry, as described in RFC2461
	  5.3. Each entry will be removed in 1day by default.

2001-01-21  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* bsdi4/bin/ping/ping.c: corrected the output format when the
	command is build without "INET6" being defined.

2001-01-21  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* bsdi4/sys/netinet/udp_usrreq.c (udp_input):
	* bsdi4/sys/netinet/tcp_input.c (tcp_input):
	made a local copy of the IPv6 header and called in6_clearscope()
	(which was newly implemented with this change) to remove
	(possibly) embedded scope identifiers.
	XXX: this change would reduce efficiency, but is necessary to
	compute checksum correctly for a packet with scoped source or
	destination addresses.
	All BSD/OS 4.2 users are recommended to apply this fix.

Sat Jan 20 JST 2001  itojun@iijlab.net
	* sys/netinet6/ipsec.c: candidate fix for KAME PR 233 (tunnelled packet
	  may cause bad ARP).

Fri Jan 19 17:09:17 JST 2001  itojun@iijlab.net
	* sys/netinet/icmp6.h: synchronize RR flag bit definitions to
	  RFC2894.  you need to compile every system you have, to make RR work.
	  KAME PR 300.

2001-01-19  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* bsdi4/sys/i386/isa/if_ef.c (efintr): do not use the sentinel
	pointer stored in ef_mb, and force the EF_NEWM macro to create a
	fresh mbuf chain to store incoming ether frames (with mbuf cluster
	if necessary). This fix is essential to the KAME IPv6 stack
	(without the m_pulldown stuff), so please be sure to apply this
	fix if you use IPv6 on an interface using the ef driver.

2001-01-18  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* bsdi4/contrib/bind/src/lib/irs/{lcl,nis}_ho.c: set ho_addrinfo
	function(s) properly. Without this fix, getaddrinfo() could cause
	SEGV when "local" or "nis" is specified to look hosts up. Be sure
	to update.

Thu Jan 18 02:00:32 JST 2001  itojun@iijlab.net
	* netbsd, openbsd, bsdi4: fix unsafe typecast in rtrequest1().
	  clarify 3rd arg handling in eonrtrequest().
	* netbsd, openbsd: integrate post-4.4BSD rtrequest1(), and argument
	  type change on ifa_rtrequest (3rd arg).

2001-01-16  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/kame/dtcp/dtcps.rb (tunnelcleanup): deleted the pair of
	physical addresses by "gifconfig delete" after the session. This
	would prevent a garbage pair.

Tue Jan 16 00:43:19 JST 2001  itojun@iijab.net
	* sys/netinet6/mld6.c: emit MLD6 packet correctly (MTU setting was
	  wrong and the packet did not go out of the node).  the bug was
	  introduced around November 27, 2000.

Mon Jan 15 12:53:37 JST 2001  yu-inoue@jp.fujitsu.com
	* route6d:
	  when an interface goes down, do not advertise routes associated with
	  the interface, more like vendor routers.  by doing so, we can
	  avoid blackhole route (advertised even though the router lost
	  reachability), and we can switch to alternate route if one exists.
	  NOTE: it may cause reachability problem to the router itself, if
	  the router has interfaces without global addresses.

Sat Jan 13 12:45:56 JST 2001  itojun@iijlab.net
	* sys/netinet/ip_output.c: allow interface index to be specified with
	  multicast set/getsockopts, by using 0.0.0.0/8 (= pass it as network
	  endian value, 24bit in in_addr).  follows RFC1724 section 3.3.
	  suggested by Dave Thaler.

Fri Jan 12 18:54:52 JST 2001  itojun@iijlab.net
	* bsdi4: use BSD/OS 4.2 as the base version.

Thu Jan 11 02:47:37 JST 2001 sakane@ydc.co.jp
	* kame/sys/netkey/key.c:
	- key_acquire() does not require a secpolicy structure.
	  There was a possibility of kernel panic.
	  reported by <dwang@iPolicyNet.COM>.

Thu Jan 11 02:46:09 JST 2001 sakane@ydc.co.jp
	* racoon:
	- saved the type of SA in PF_KEY acquire message from the kernel
	  in order to reply a error.
	- removed from the scheduler immediately if error happened when sending
	  phase 1 initiation message.

Wed Jan 10 11:41:30 JST 2001 sakane@ydc.co.jp
	* racoon:
	- Fixed to configure the logging level.  racoon saves some parameters
	  before parsing configuration file in order to prefer the parameters
	  by command line.

Wed Jan 10 00:19:59 JST 2001  itojun@iijlab.net
	* sys/netinet6/icmp6.c: fix SEGV on icmp6 redirect input.
	  openbsd/netbsd only.  was introduced early Dec2000.

Tue Jan  9 16:50:07 JST 2001  itojun@iijlab.net
	* kame/libinet6/getaddrinfo.c: share getaddrinfo source code (again)
	  across all platforms we have.  though we have a jumbo #ifdef at the
	  bottom for DNS lookup portion, it is good to share the core logic.
	  while we are at it, simplify lots of things.
	  freebsd4 behavior change: $GAI support is dropped.  classful notation
	  (127.1) is dropped.

2001-01-07  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/sys/netinet6/in6_pcb.c (in6_pcbnotify):
	* {bsdi4,freebsd[34],openbsd}/sys/netinet6/in6_pcb.c (in6_pcbbind):
	allowed an application to bind a socket to a deprecated address.
	For openbsd, a new check if the specified address is a node's own
	address was added as well.

2001-01-07  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* freebsd3/ports/libbind8: newly added based on BIND 8.2.2p7. This
	libbind supported A6 and DNAME.

2001-01-06  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/kame/prefix/prefix.c: changed the default values of
	prefixes to infinity. Finite default values were bad, because they
	would be installed as the lifetimes of routers' addresses, which
	would never increment and be invalidated in the future.

	NOTE: if you use the kernel that has the change made on 2000-12-03
	by Koji Kawano (see CHANGELOG.2000) on a router box, and use the
	prefix command to assign addresses for the router, please be sure
	to update the prefix command and reboot the router (or at least
	reassign the addresses by the new prefix command). The lifetimes
	might now be decresing, and will expire in the near future.

	We'd even recommend you not to use the prefix command. It has
	recently caused many problematic situations, and almost no one
	understands the kernel prefix management routines well. You can do
	the same thing by the ordinally ifconfig command. See the latest
	rc.net6.sample file.

2001-01-06  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* kame/kame/etc/rc.net6: prohibit the prefix command by default.
	Since the command has recently caused many problems, we should
	reconsider the prefix management mechanism.

Fri Jan  5 22:51:16 JST 2001  itojun@iijlab.net
	* libinet6/name6.c: nuke getnodeby{name,addr}, which was mentioned
	  only in draft-ietf-ipngwg-bsd-api-new-01.txt.

Fri Jan  5 13:24:21 JST 2001  itojun@iijlab.net
	* getaddrinfo.c (shared/netbsd/openbsd/freebsd4)
	  query DNS only once per an AF.

2001-01-05  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* bsdi4/contrib/bind/src/lib/irs/gethostent.c: allowed gethostbyname
	to accept abbreviated IPv4 text addresses (like 127.1).
	(XXX: this change is against a bind8 policy, but just for backward
	compatibility.)

2001-01-02  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* freebsd3/lib/libinet6/Makefile: do not link resolver files when
	USE_LIBBIND6 is YES, so that enhanced libbind could be tested.
	* freebsd3/*/Makefile.inc: when USE_LIBBIND6 is YES, link libbind
	(as well as libinet6).

Tue Jan  2 17:15:44 JST 2001  itojun@iijlab.net
	* sys/netinet6/in6{,_ifattach}.c: correct use of IFAREF/IFFREE on
	  non-netbsd operating systems.  old code had memory leak possibility
	  on SIOCDIFADDR_IN6.  reported by hitachi guys.

2001-01-01  JINMEI, Tatuya  <jinmei@isl.rdc.toshiba.co.jp>
	* bsdi4/lib/libinet6:
	* bsdi4/contrib/bind/src/lib:
	massive improvements on DNS resolver including
	- IPv6 transport of DNS resolver. An IPv6 textual address can now
	  be in the /etc/resolv.conf file as a DNS server.
	- support of A6 and DNAME with bit string labels. They are still
	  very experimental, and thus disabled by default. "options a6"
	  and "options dname" in the /etc/resolv.conf file would enable A6
	  and DNAME, respectively.
	- EDNS0 OPT RR support with UDP buffer size negotiation. which is
	  disabled by default, and would enabled by "options edns0" in the
	  /etc/resolv.conf file.
	- clarification on the relationship between address family and irs
	  functions. For example, if you call getaddrinfo with AF_UNSPEC,
	  and irs.conf specifies to consider the local hosts file first,
	  then getaddrinfo would try to resolve an address in the
	  following order:
	  + IPv6 addresses in the hosts file.
	  + IPv4 addresses in the hosts file.
	  + IPv6 addresses via DNS.
	  + IPv4 addresses via DNS.
	  And, if one of the first two attempts succeeded, the remaining
	  two methods would be skipped. This change of the behavior would
	  be useful if you put both IPv6 and IPv4 addresses in the hosts
	  file, and do not want to see redundant DNS packets.
